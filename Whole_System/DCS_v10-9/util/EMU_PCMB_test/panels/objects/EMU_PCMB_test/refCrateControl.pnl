V 10
1
LANG:1 0 
PANEL,-1 -1 142 172 N "_3DFace" 1
"$elmbDp"
"main()
{
  string stateDp = $elmbDp + \".state.noToggle\";
  if (!dpExists(stateDp)) { // on older ELMB component versions state.noToggle DPE doesn't exists so then use the state.value and dismis the toggle bit at the work function
    stateDp = $elmbDp + \".state.value\"; 
    stateWithToggleBit = true;
  }
  // hook up the elmb state
  dpConnect(\"elmbStateUpdatedCB\", true, stateDp);
}" 0
 E E E E 1 -1 -1 0  0 0
""0  1
E "bool stateWithToggleBit = false; // if an older ELMB component is used then we use the state with toggle bit and dismiss that at CB func.


void elmbStateUpdatedCB(string dpe, int state) {
  if (stateWithToggleBit) {
    state &= 127; // dismiss the toggle bit
  }
  
  if (state == 5) { // OPERATIONAL
    btnOn.enabled = true;
    btnOff.enabled = true;
  } else {
    btnOn.enabled = false;
    btnOff.enabled = false;
  }
}

// ---------============== CONTROL ===============---------------
void pcTurnOn(string elmbDp, unsigned delayMs) {
  dyn_string exception;
  
  emu_info(\"Switching ON crate hooked up with ELMB: \" + elmbDp);

  //ensure we're not in the suspend/standby state
  fwElmbUser_setDoBit(elmbDp, \"A;7\", FALSE, exception);
  if (emu_checkException(exception) > 0) { return; }
  delay(0, delayMs / 2);
  fwElmbUser_setDoBit(elmbDp, \"A;6\", FALSE, exception);
  if (emu_checkException(exception) > 0) { return; }
  delay(0, delayMs / 2);
  fwElmbUser_setDoBit(elmbDp, \"A;5\", FALSE, exception);
  if (emu_checkException(exception) > 0) { return; }
  delay(0, delayMs / 2);

  //turn on some power
  fwElmbUser_setDoBit(elmbDp, \"A;3\", FALSE, exception);
  if (emu_checkException(exception) > 0) { return; }
  if (toggleControlBit(elmbDp, delayMs) == -1) { return; } // toggle control bit and check for exception
  
  //turn on boards
  for (int i=0; i < 8; i++) {  // turn ON the first 8 TMB/DMB pairs
    fwElmbUser_setDoBit(elmbDp, \"C;\" + i, FALSE, exception);
    if (emu_checkException(exception) > 0) { return; }
    if (toggleControlBit(elmbDp, delayMs) == -1) { return; } // toggle control bit and check for exception
  }
  fwElmbUser_setDoBit(elmbDp, \"A;0\", FALSE, exception); // turn ON the last - 9th TMB/DMB pair
  if (emu_checkException(exception) > 0) { return; }
  if (toggleControlBit(elmbDp, delayMs) == -1) { return; } // toggle control bit and check for exception
  
  //turn on the rest of the power
  fwElmbUser_setDoBit(elmbDp, \"A;1\", FALSE, exception);
  if (emu_checkException(exception) > 0) { return; }
  delay(0, delayMs / 2);
  fwElmbUser_setDoBit(elmbDp, \"A;2\", FALSE, exception);
  if (emu_checkException(exception) > 0) { return; }
  if (toggleControlBit(elmbDp, delayMs) == -1) { return; } // toggle control bit and check for exception
}

void pcTurnOff(string elmbDp, unsigned delayMs) {
  dyn_string exception;
  
  emu_info(\"Switching OFF crate hooked up with ELMB: \" + elmbDp);
  
  fwElmbUser_setDoBytes(elmbDp, 0x1fff, exception);
  if (emu_checkException(exception) > 0) { return; }
  
  toggleControlBit(elmbDp, delayMs);
}

int toggleControlBit(string node, unsigned delayMs) {
  dyn_string exception;
  
  delay(0, delayMs / 2);
  fwElmbUser_setDoBit(node, \"A;4\", FALSE, exception);
  if (emu_checkException(exception) > 0) { return -1; }
  delay(0, delayMs / 2);
  fwElmbUser_setDoBit(node, \"A;4\", TRUE, exception);
  if (emu_checkException(exception) > 0) { return -1; }
  return 0;
}
" 0
 2
"CBRef" "1"
"EClose" E
""
DISPLAY_LAYER, 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0
LAYER, 0 
1
LANG:1 0 
13 0
"btnOn"
""
1 9.99999999999995 9.99999999999999 E E E 1 E 1 E N "_ButtonText" E N "_Button" E E
 E E
1 0 0 0 0 0
E E E
0
1
LANG:1 0 

0
1
LANG:1 98 -*-MS Shell Dlg-*-r-normal-*-11-*-100-100-*-*-iso8859-1|-11,0,0,0,505,0,0,0,0,0,0,0,0,MS Shell Dlg
0 ""
 8 8 132 35

T 
1
LANG:1 7 Turn ON
"main()
{
  this.enabled = false;
  btnOff.enabled = false;
  pcTurnOn($elmbDp, (unsigned) spinDelay.text);
  this.enabled = true;
  btnOff.enabled = true;
}" 0
 E E E
13 1
"btnOff"
""
1 9.99999999999995 40 E E E 1 E 1 E N "_ButtonText" E N "_Button" E E
 E E
3 0 0 0 0 0
E E E
0
1
LANG:1 0 

0
1
LANG:1 98 -*-MS Shell Dlg-*-r-normal-*-11-*-100-100-*-*-iso8859-1|-11,0,0,0,505,0,0,0,0,0,0,0,0,MS Shell Dlg
0 ""
 8 38 132 65

T 
1
LANG:1 8 Turn OFF
"main()
{
  this.enabled = false;
  btnOff.enabled = false;
  pcTurnOff($elmbDp, (unsigned) spinDelay.text);
  this.enabled = true;
  btnOff.enabled = true;
}" 0
 E E E
21 2
"spinDelay"
""
1 71.8518518518518 142 E E E 1 E 1 E N "_WindowText" E N "_Window" E E
 E E
5 0 0 0 0 0
E E E
0
1
LANG:1 0 

0
1
LANG:1 98 -*-MS Shell Dlg-*-r-normal-*-11-*-100-100-*-*-iso8859-1|-11,0,0,0,505,0,0,0,0,0,0,0,0,MS Shell Dlg
0 ""
 69.8518518518518 140 136.575866188769 163
0

E
E
E

N 0 10000 1 500 1 1
2 3
"PRIMITIVE_TEXT3"
""
1 11.7146776406036 142 E E E 1 E 1 E N "_WindowText" E N "_Transparent" E E
 E E
7 0 0 0 0 0
E E E
0
1
LANG:1 0 

1
"dashclr"N "_Transparent"
E E 0 1 1 2 1 E 0.925925925925926 0 1 -17.7777777777778 10 1 E 32 132 81 146
0 2 2 "0s" 0 0 0 192 0 0  32 132 1
1
LANG:1 98 -*-MS Shell Dlg-*-r-normal-*-11-*-100-100-*-*-iso8859-1|-11,0,0,0,505,0,0,0,0,0,0,0,0,MS Shell Dlg
0 ""
1
LANG:1 10 Delay (ms)
0
LAYER, 1 
1
LANG:1 0 
0
LAYER, 2 
1
LANG:1 0 
0
LAYER, 3 
1
LANG:1 0 
0
LAYER, 4 
1
LANG:1 0 
0
LAYER, 5 
1
LANG:1 0 
0
LAYER, 6 
1
LANG:1 0 
0
LAYER, 7 
1
LANG:1 0 
0
0