<?xml version="1.0" encoding="UTF-8"?>
<process
    name="pullTmbCounters"
    targetNamespace="http://www.cern.ch/cms/csc/exsys/bpel/pullTmbCounters"
    xmlns:tns="http://www.cern.ch/cms/csc/exsys/bpel/pullTmbCounters"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling" xmlns:sxed2="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor2" xmlns:sxxf="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/XPathFunctions" xmlns:ns0="http://www.cern.ch/cms/csc/dw/model" xmlns:ns1="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
    <import namespace="http://www.cern.ch/cms/csc/exsys/wsdl/pullTmbCountersScheduler" location="pullTmbCountersScheduler.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/HttpProxyWSServiceWrapper" location="HttpProxyWSServiceWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://ws.exsys.csc.cms.cern.org/" location="ExsysEsbEjb/wsdl/HttpProxy/HttpProxyWSService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://www.cern.ch/cms/csc/dw/model" location="CdwModel/org/cern/cms/csc/dw/schema/fact.xsd" importType="http://www.w3.org/2001/XMLSchema"/>
    <import namespace="http://www.cern.ch/cms/csc/exsys/wsdl/getFactCollection" location="getFactCollection.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://ws.dw.csc.cms.cern.org/" location="../CdwWS/Cdw.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="HttpProxyPartner" xmlns:tns="http://enterprise.netbeans.org/bpel/HttpProxyWSServiceWrapper" partnerLinkType="tns:HttpProxyWSLinkType" partnerRole="HttpProxyWSRole"/>
        <partnerLink name="CdwPartner" xmlns:tns="http://ws.dw.csc.cms.cern.org/" partnerLinkType="tns:factcollectionLinkType" partnerRole="factcollectionRole"/>
        <partnerLink name="SchedulerPartner" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl/pullTmbCountersScheduler" partnerLinkType="tns:pullTmbCountersScheduler" myRole="TriggerPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="numberSaved" xmlns:tns="http://ws.dw.csc.cms.cern.org/" messageType="tns:inputResponse"/>
        <variable name="factCollection" xmlns:tns="http://ws.dw.csc.cms.cern.org/" messageType="tns:input"/>
        <variable name="counters" xmlns:tns="http://ws.exsys.csc.cms.cern.org/" messageType="tns:requestXmlResponse"/>
        <variable name="xmasUrl" xmlns:tns="http://ws.exsys.csc.cms.cern.org/" messageType="tns:requestXml"/>
        <variable name="pullUrl" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl/pullTmbCountersScheduler" messageType="tns:TriggerEventMessage"/>
    </variables>
    <sequence>
        <receive name="ReceiveSchedulerTrigger" createInstance="yes" partnerLink="SchedulerPartner" operation="FireTriggerOperation" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl/pullTmbCountersScheduler" portType="tns:TriggerPortType" variable="pullUrl"/>
        <assign name="SetXmasUrl">
            <sxt:trace>
                <sxt:log level="info" location="onComplete">
                    <from>concat('Pulling TMB trigger counters from: ', $pullUrl.schedPart)</from>
                </sxt:log>
            </sxt:trace>
            <copy>
                <from variable="pullUrl" part="schedPart"/>
                <to>$xmasUrl.parameters/url</to>
            </copy>
        </assign>
        <invoke name="PullTmbCounters" partnerLink="HttpProxyPartner" operation="requestXml" xmlns:tns="http://ws.exsys.csc.cms.cern.org/" portType="tns:HttpProxyWS" outputVariable="counters" inputVariable="xmasUrl"/>

        <!-- transform -->
        <assign name="TransformToFactCollection">
            <copy>
                <from>ns1:doXslTransform('urn:stylesheets:emuCountersToFactCollection.xsl', sxxf:doUnMarshal($counters.parameters))</from>
                <to>$factCollection.parameters/factCollection</to>
            </copy>
        </assign>

        <!-- log the outcome of the transformation - for testing only -->
        <assign name="LogFactCollection">
            <sxt:trace>
                <sxt:log level="info" location="onComplete">
                    <ns1:from variable="factCollection" part="parameters"/>
                </sxt:log>
            </sxt:trace>
            <copy>
                <from variable="pullUrl" part="schedPart"/>
                <to variable="pullUrl" part="schedPart"/>
            </copy>
        </assign>

        <!-- Send to Cdw and log the response -->
        <invoke name="SendToCdw" partnerLink="CdwPartner" operation="input" xmlns:tns="http://ws.dw.csc.cms.cern.org/" portType="tns:factcollection" inputVariable="factCollection" outputVariable="numberSaved"/>
        <!--invoke name="SendToCdw" partnerLink="CdwPartner" operation="getFactCollection" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl/getFactCollection" portType="tns:getFactCollectionPortType" inputVariable="factCollection" outputVariable="numberSaved"/-->
        <assign name="LogCdwResponse">
            <sxt:trace>
                <sxt:log level="info" location="onComplete">
                    <ns1:from>concat('Number of facts saved: ', $numberSaved.parameters)</ns1:from>
                </sxt:log>
            </sxt:trace>
            <copy>
                <from variable="pullUrl" part="schedPart"/>
                <to variable="pullUrl" part="schedPart"/>
            </copy>
        </assign>
    </sequence>
</process>
















