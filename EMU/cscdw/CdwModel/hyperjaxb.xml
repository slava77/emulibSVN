<?xml version="1.0"?>

<project name="hyperjaxb3-hibernate-ant" default="generate-model">

	<property name="artifactId" value="hyperjaxb3-po-initial-ant"/>
	<property name="version" value="0.5.4"/>
    <property name="libs" location="${basedir}/../lib/hyperjaxb3" />
    <property name="plugin-dir" location="${basedir}/build/plugin"/>
    <property name="srcs" location="${basedir}/src/java" />

    <target name="build-plugins">

        <delete dir="${plugin-dir}" failonerror="false"/>
        <mkdir dir="${plugin-dir}"/>

        <javac destdir="build/plugin">
            <src path="${srcs}"/>
            <include name="org/jvnet/**"/>
            <exclude name="org/cern/**"/>
            <classpath>
				<fileset dir="${libs}">
					<include name="*.jar"/>
				</fileset>
            </classpath>
        </javac>

        <copy todir="${plugin-dir}/META-INF/services">
            <fileset dir="${srcs}/META-INF/services"/>
        </copy>

    </target>

    <target name="hj-taskdef" depends="build-plugins">
		<taskdef name="xjc" classname="org.jvnet.jaxb2_commons.xjc.XJC2Task">
			<classpath>
				<fileset dir="${libs}">
					<include name="activation-*.jar"/>
					<include name="jaxb-api-*.jar"/>
					<include name="jaxb-impl-*.jar"/>
					<include name="jsr173_api-*.jar"/>
					<include name="stax-api-*.jar"/>
					<include name="jaxb-xjc-*.jar"/>
					<include name="codemodel-*.jar"/>
					<include name="dtd-parser-*.jar"/>
					<include name="istack-commons-tools-*.jar"/>
					<include name="relaxngDatatype-*.jar"/>
					<include name="resolver-*.jar"/>
					<include name="rngom-*.jar"/>
					<include name="xsom-*.jar"/>
					<include name="jaxb2-basics-ant-*.jar"/>
				</fileset>
			</classpath>
		</taskdef>
    </target>

    <target name="generate-ontology-schema">

        <delete file="src/java/org/cern/cms/csc/dw/schema/ontologyClassifiers.xsd" failonerror="false" />
        <xslt style="src/java/org/cern/cms/csc/dw/dev/template/ontologyClassifiers.xsl"
              in="../KnowledgeBase/ontology/csc-ontology.owl"
              out="src/java/org/cern/cms/csc/dw/schema/ontologyClassifiers.xsd"/>

    </target>

    <target name="import-ontology">

        <!-- Copy over persistence configuration -->
        <delete file="build/jar/META-INF/persistence.xml"/>
        <copy file="src/conf/persistence.xml" todir="build/jar/META-INF"/>

        <!-- Create database properties file -->
        <delete file="build/jar/META-INF/persistence.properties" failonerror="false" />
        <xslt style="src/java/org/cern/cms/csc/dw/dev/template/persistenceProperties.xsl"
              in="build/jar/META-INF/persistence.xml"
              out="build/jar/META-INF/persistence.properties"/>

        <!-- Load JPA connection properties and remove file -->
        <property file="build/jar/META-INF/persistence.properties"/>
        <delete file="build/jar/META-INF/persistence.properties" failonerror="true" />

        <!-- Execute SQL files -->
        <sql driver="${hibernate.connection.driver_class}" url="${hibernate.connection.url}" userid="${hibernate.connection.username}" password="${hibernate.connection.password}"
            delimiter="/" keepformat="true" delimitertype="row" onerror="continue">
            <classpath>
                <pathelement path="build/jar"/>
                <fileset dir="build/jar">
                    <include name="*.jar"/>
                </fileset>
            </classpath>
            <transaction src="src/java/org/cern/cms/csc/dw/dev/sql/cdw_utility.sql"/>
            <transaction src="src/java/org/cern/cms/csc/dw/dev/sql/cdw_ontology_pre_import.sql"/>
        </sql>

        <!-- Execute main data import procedure -->
        <java classname="org.cern.cms.csc.dw.dev.ComponentImporter" fork="true" failonerror="true">
            <jvmarg line="-Xmn100M -Xms500M -Xmx500M -Xss100M"/>
            <arg value="../KnowledgeBase/ontology/csc-ontology.owl"/>
            <classpath>
                <pathelement path="build/jar"/>
                <fileset dir="build/jar">
                    <include name="*.jar"/>
                </fileset>
            </classpath>
        </java>

        <!-- Execute SQL files -->
        <sql driver="${hibernate.connection.driver_class}" url="${hibernate.connection.url}" userid="${hibernate.connection.username}" password="${hibernate.connection.password}"
            delimiter="/" keepformat="true" delimitertype="row" autocommit="true" onerror="continue">
            <classpath>
                <pathelement path="build/jar"/>
                <fileset dir="build/jar">
                    <include name="*.jar"/>
                </fileset>
            </classpath>
            <transaction src="src/java/org/cern/cms/csc/dw/dev/sql/cdw_ontology_indexes.sql"/>
            <transaction src="src/java/org/cern/cms/csc/dw/dev/sql/cdw_ontology.sql"/>
            <transaction src="src/java/org/cern/cms/csc/dw/dev/sql/cdw_ontology_post_import.sql"/>
            <transaction>
                select count(*) as "ORPHAN FACTS LEFT" from cdw_facts where fct_cmp_id is null
            </transaction>
        </sql>

    </target>

    <target name="generate-model" depends="generate-ontology-schema,hj-taskdef">

        <delete failonerror="false">
            <fileset dir="${srcs}/org/cern/cms/csc/dw/model/ontology" includes="**/*.java"/>
            <fileset dir="${srcs}/org/cern/cms/csc/dw/model/fact" includes="**/*.java"/>
            <fileset dir="${srcs}/org/cern/cms/csc/dw/model/test" includes="**/*.java"/>
        </delete>

		<xjc destdir="${srcs}" extension="true">
			<arg line="
				-Xhyperjaxb3-ejb
				-Xhyperjaxb3-ejb-roundtripTestClassName=org.cern.cms.csc.dw.model.test.RoundtripTest
				-Xequals
				-Xinheritance
				-XhashCode
				-XtoString
                -Xsuperclass
                -Xhibernate"/>
			<binding dir="${basedir}">
			 	<include name="*.xjb"/>
			</binding>
            <schema file="${srcs}/org/cern/cms/csc/dw/schema/cdw.xsd"/>
			<classpath>
				<fileset dir="${libs}">
					<include name="*.jar"/>
				</fileset>
                <pathelement location="${plugin-dir}"/>
			</classpath>
		</xjc>

        <!-- Fix ontology classes -->

        <replace file="${srcs}/org/cern/cms/csc/dw/model/ontology/ComponentClass.java">
            <replacefilter token="PARENT_COMPONENTCLASS_IDITEM" value="CCP_PARENT_CCL_ID"/>
            <replacefilter token="CHILD_COMPONENTCLASS_IDITEM" value="CCP_CHILD_CCL_ID"/>
        </replace>

        <replace file="${srcs}/org/cern/cms/csc/dw/model/fact/FactCollection.java"
            token="FACTSITEMS_FACTCOLLECTION_ID"
            value="FIT_FCO_ID"/>

        <replace file="${srcs}/org/cern/cms/csc/dw/model/fact/FactCollectionFactsItem.java">
            <replacefilter token="FACTCOLLECTIONFACTSITEM" value="CDW_FACT_COLLECTION_ITEMS"/>
            <replacefilter token="Hjid" value="Id"/>
            <replacefilter token="hjid" value="id"/>
            <replacefilter token="HJID" value="FIT_ID"/>
            <replacefilter token="ITEMNAME" value="FIT_TYPE"/>
            <replacefilter token="ITEMVALUE_FACTCOLLECTIONFACT_0" value="FIT_FCT_ID"/>
        </replace>

    </target>

</project>