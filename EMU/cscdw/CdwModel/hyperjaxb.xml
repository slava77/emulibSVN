<?xml version="1.0"?>

<project name="hyperjaxb3-hibernate-ant" default="hj-generate-sources">

	<property name="artifactId" value="hyperjaxb3-po-initial-ant"/>
	<property name="version" value="0.5.4"/>
    <property name="libs" location="${basedir}/../lib/hyperjaxb3" />
    <property name="srcs" location="${basedir}/src/java" />

    <path id="compile.path">
		<fileset dir="${libs}">
			<include name="commons-lang-*.jar"/>
			<include name="jaxb-api-*.jar"/>
			<include name="jaxb2-basics-runtime-*.jar"/>
			<include name="persistence-api-*.jar"/>
			<include name="hyperjaxb3-ejb-runtime-*.jar"/>
			<include name="junit-*.jar"/>
			<include name="hyperjaxb3-ejb-roundtrip-*.jar"/>
		</fileset>
	</path>
	<path id="test-compile.path">
		<fileset dir="${libs}">
			<include name="activation-*.jar"/>
			<include name="jaxb-api-*.jar"/>
			<include name="jaxb-impl-*.jar"/>
			<include name="stax-api-*.jar"/>
			<include name="jsr173_api-*.jar"/>
			<include name="jaxb2-basics-runtime-*.jar"/>
			<include name="junit-*.jar"/>
			<include name="jaxb2-basics-testing-*.jar"/>
			<include name="xmlunit-*.jar"/>
			<include name="commons-lang-*.jar"/>
			<include name="commons-logging-*.jar"/>
			<include name="persistence-api-*.jar"/>
			<include name="hyperjaxb3-ejb-runtime-*.jar"/>
			<include name="junit-*.jar"/>
			<include name="hyperjaxb3-ejb-roundtrip-*.jar"/>
		</fileset>
	</path>
	<path id="test.path">
		<fileset dir="${libs}">
			<include name="activation-*.jar"/>
			<include name="jaxb-api-*.jar"/>
			<include name="jaxb-impl-*.jar"/>
			<include name="stax-api-*.jar"/>
			<include name="jsr173_api-*.jar"/>
			<include name="jaxb2-basics-runtime-*.jar"/>
			<include name="junit-*.jar"/>
			<include name="jaxb2-basics-testing-*.jar"/>
			<include name="xmlunit-*.jar"/>
			<include name="commons-io-*.jar"/>
			<include name="commons-lang-*.jar"/>
			<include name="commons-logging-*.jar"/>
			<include name="commons-collections-*.jar"/>
			<include name="dom4j-*.jar"/>
			<include name="ehcache-*.jar"/>
			<include name="antlr-*.jar"/>
			<include name="asm-*.jar"/>
			<include name="asm-attrs-*.jar"/>
			<include name="cglib-*.jar"/>
			<include name="hibernate-*.jar"/>
			<include name="hibernate-annotations-*.jar"/>
			<include name="hibernate-entitymanager-*.jar"/>
			<include name="javassist-*.jar"/>
			<include name="jboss-archive-browsing-*.jar"/>
			<include name="jboss-common-core-*.jar"/>
			<include name="hsqldb-*.jar"/>
			<include name="hyperjaxb3-ejb-runtime-*.jar"/>
			<include name="hyperjaxb3-ejb-roundtrip-*.jar"/>
			<include name="persistence-api-*.jar"/>
			<include name="jta-*.jar"/>
			<include name="log4j-*.jar"/>
			<include name="slf4j-*.jar"/>
			<include name="xmlunit-*.jar"/>
		</fileset>
	</path>

    <target name="hj-clean">
        <delete>
            <fileset dir="${srcs}/org/cern/cms/csc/dw/model" includes="**/*.java"/>
        </delete>
	</target>

	<target name="hj-generate-sources" depends="hj-clean">

		<taskdef name="xjc" classname="org.jvnet.jaxb2_commons.xjc.XJC2Task">
			<!-- XJC2 Task classpath -->
			<classpath>
				<fileset dir="${libs}">
					<include name="activation-*.jar"/>
					<include name="jaxb-api-*.jar"/>
					<include name="jaxb-impl-*.jar"/>
					<include name="jsr173_api-*.jar"/>
					<include name="stax-api-*.jar"/>
					<include name="jaxb-xjc-*.jar"/>
					<include name="codemodel-*.jar"/>
					<include name="dtd-parser-*.jar"/>
					<include name="istack-commons-tools-*.jar"/>
					<include name="relaxngDatatype-*.jar"/>
					<include name="resolver-*.jar"/>
					<include name="rngom-*.jar"/>
					<include name="xsom-*.jar"/>
					<include name="jaxb2-basics-ant-*.jar"/>
				</fileset>
			</classpath>
		</taskdef>

		<!--mkdir dir="${basedir}/target/generated-sources/xjc"/-->
		<xjc destdir="${srcs}" extension="true">
			<arg line="
				-Xhyperjaxb3-ejb
				-Xhyperjaxb3-ejb-roundtripTestClassName=org.cern.cms.csc.dw.model.test.RoundtripTest
				-Xequals
				-Xinheritance
				-XhashCode
				-XtoString"/>
			<binding dir="${basedir}">
			 	<include name="*.xjb"/>
			</binding>
            <schema dir="${srcs}">
			 	<include name="**/fact.xsd"/>
			</schema>
			<classpath>
				<fileset dir="${libs}">
					<include name="*.jar"/>
				</fileset>
			</classpath>
		</xjc>

        <!-- Apply specific fixes -->
        
        <replace file="${srcs}/org/cern/cms/csc/dw/model/FactCollection.java" 
            token="FACTCOLLECTIONFACTITEM"
            value="CDW_FACT_COLLECTION_ITEMS"/>

	</target>
	<target name="hj-compile" depends="hj-generate-sources">
		<mkdir dir="${basedir}/target/classes"/>
		<javac
			destdir="${basedir}/../../build"
			srcdir="${srcs}/org/cern/cms/csc/dw/model"
			classpathref="compile.path"
			source="1.5"
			target="1.5">
		</javac>
	</target>
	<target name="hj-test-compile" depends="hj-compile">
		<mkdir dir="${basedir}/target/test-classes"/>
		<javac
			destdir="${basedir}/target/test-classes"
			srcdir="${basedir}/src/test/java:${basedir}/target/generated-sources/xjc"
			classpathref="test-compile.path"
			source="1.5"
			target="1.5">
		</javac>
		<copy todir="${basedir}/target/test-classes">
			<fileset dir="${basedir}/src/test/resources"/>
			<fileset dir="${basedir}/target/generated-sources/xjc">
				<exclude name="**/*.java" />
			</fileset>
		</copy>
	</target>
	<target name="hj-test" depends="hj-test-compile">
		<mkdir dir="${basedir}/target/junit-reports"/>
		<junit printsummary="yes" haltonfailure="yes">
			<classpath>
				<pathelement location="${basedir}/target/classes"/>
				<pathelement location="${basedir}/target/test-classes"/>
				<path refid="test.path"/>
			</classpath>

			<formatter type="plain"/>
			<formatter type="xml"/>

			<batchtest fork="yes" todir="${basedir}/target/junit-reports">
				<fileset dir="${basedir}/src/test/java">
					<include name="**/*Test*.java"/>
					<exclude name="**/AllTests.java"/>
				</fileset>
				<fileset dir="${basedir}/target/generated-sources/xjc">
					<include name="**/*Test*.java"/>
					<exclude name="**/AllTests.java"/>
				</fileset>
			</batchtest>
		</junit>
	</target>
	<target name="hj-package" depends="hj-test">
		<mkdir dir="${basedir}/target"/>
		<jar destfile="${basedir}/target/${artifactId}-${version}.jar"
			basedir="${basedir}/target/classes"/>
	</target>
	<target name="hj-install" depends="hj-package"/>
</project>