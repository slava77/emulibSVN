<?xml version="1.0" encoding="UTF-8"?>
<process
    name="pullTmbTriggerCounters"
    targetNamespace="http://www.cern.ch/cms/csc/exsys/bpel"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxat="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Attachment"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling"
    xmlns:tns="http://www.cern.ch/cms/csc/exsys/bpel" xmlns:sxed2="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor2" xmlns:ns0="http://www.cern.ch/cms/csc/exsys/data">
    <import namespace="http://www.cern.ch/cms/csc/exsys/wsdl" location="ExSysWS/wsdl/EmuCountersProxyWS/getEmuCounters.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://j2ee.netbeans.org/wsdl/CdwWS/pullTmbTriggerCountersScheduler" location="pullTmbTriggerCountersScheduler.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://www.cern.ch/cms/csc/exsys/wsdl" location="getParameterCollection.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="tmbTriggerCountersProxyPartner" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" partnerLinkType="tns:getEmuCounters" partnerRole="getEmuCountersPortTypeRole"/>
        <partnerLink name="tmbTriggerCountersPullSchedulerPartner" xmlns:tns="http://j2ee.netbeans.org/wsdl/CdwWS/pullTmbTriggerCountersScheduler" partnerLinkType="tns:pullTmbTriggerCountersScheduler" myRole="TriggerPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="GetParameterCollectionOperationResponse" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" messageType="tns:getParameterCollectionOperationResponse"/>
        <variable name="ParameterCollection" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" messageType="tns:getParameterCollectionOperationRequest"/>
        <variable name="TmbTriggerCounters" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" messageType="tns:getEmuCountersResponse"/>
        <variable name="TmbTriggerCountersUrl" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" messageType="tns:getEmuCountersRequest"/>
        <variable name="FireTriggerOperationIn" xmlns:tns="http://j2ee.netbeans.org/wsdl/CdwWS/pullTmbTriggerCountersScheduler" messageType="tns:TriggerEventMessage"/>
    </variables>
    <sequence>
        <receive name="SchedulerTrigger" createInstance="yes" partnerLink="tmbTriggerCountersPullSchedulerPartner" operation="FireTriggerOperation" xmlns:tns="http://j2ee.netbeans.org/wsdl/CdwWS/pullTmbTriggerCountersScheduler" portType="tns:TriggerPortType" variable="FireTriggerOperationIn"/>
        <assign name="AssignURL">
            <copy>
                <from>'http://macfrank:20044/urn:xdaq-application:lid=30/XmlOutput'</from>
                <to variable="TmbTriggerCountersUrl" part="url"/>
            </copy>
        </assign>
        <invoke name="pullTmbTriggerCounters" partnerLink="tmbTriggerCountersProxyPartner" operation="getEmuCounters" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" portType="tns:getEmuCountersPortType" inputVariable="TmbTriggerCountersUrl" outputVariable="TmbTriggerCounters"/>
        <assign name="TransformToFact">
            <sxt:trace>
<!--
                <sxt:log level="info" location="onComplete">
                    <from>concat('Parameter collection:', $ParameterCollection.collection)</from>
                </sxt:log>
-->
                <sxt:log level="info" location="onComplete">
                    <from>concat('got from proxy:', $TmbTriggerCounters.counters)</from>
                </sxt:log>
            </sxt:trace>

<!--
            <copy>
                <from>'Xmas'</from>
                <to>$ParameterCollection.collection/ns0:source</to>
            </copy>
            <copy>
                <from>$TmbTriggerCounters.counters/@dateTime</from>
                <to>$ParameterCollection.collection/ns0:parameter/ns0:time</to>
            </copy>
            <copy>
                <from>$TmbTriggerCounters.counters/sample/count/@chamber</from>
                <to>$ParameterCollection.collection/ns0:parameter/ns0:component</to>
            </copy>
            <copy>
                <from>concat($TmbTriggerCounters.counters/sample/@name, '_ALCT_trigger_counter')</from>
                <to>$ParameterCollection.collection/ns0:parameter/ns0:parameterId</to>
            </copy>
            <copy>
                <from>$TmbTriggerCounters.counters/sample/count/@alct</from>
                <to>$ParameterCollection.collection/ns0:parameter/ns0:numericValue</to>
            </copy>
            <copy>
                <from>-1</from>
                <to>$ParameterCollection.collection/ns0:parameter/ns0:run</to>
            </copy>
-->
            <copy>
                <from variable="TmbTriggerCountersUrl" part="url"/>
                <to variable="TmbTriggerCountersUrl" part="url"/>
            </copy>
        </assign>
    </sequence>
</process>
