<?xml version="1.0" encoding="UTF-8"?>
<process
    name="pullTmbCounters"
    targetNamespace="http://enterprise.netbeans.org/bpel/CdwBpel/pullTmbCounters"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxat="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Attachment"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling"
    xmlns:tns="http://enterprise.netbeans.org/bpel/CdwBpel/pullTmbCounters" xmlns:sxed2="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor2" xmlns:ns0="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
    <import namespace="http://www.cern.ch/cms/csc/exsys/wsdl/pullTmbCountersScheduler" location="pullTmbCountersScheduler.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://www.cern.ch/cms/csc/exsys/wsdl" location="ExSysWS/org/cern/cms/csc/exsys/ws/wsdl/getEmuCounters.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://www.cern.ch/cms/csc/exsys/wsdl" location="getParameterCollection.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="EmuCountersProxyPartner" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" partnerLinkType="tns:getEmuCounters" partnerRole="getEmuCountersPortTypeRole"/>
        <partnerLink name="ExSysPartner" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" partnerLinkType="tns:getParameterCollection" partnerRole="getParameterCollectionPortTypeRole"/>
        <partnerLink name="SchedulerPartner" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl/pullTmbCountersScheduler" partnerLinkType="tns:pullTmbCountersScheduler" myRole="TriggerPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="numberOfParametersSaved" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" messageType="tns:getParameterCollectionOperationResponse"/>
        <variable name="parameterCollection" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" messageType="tns:getParameterCollectionOperationRequest"/>
        <variable name="emuCounters" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" messageType="tns:getEmuCountersResponse"/>
        <variable name="emuCountersUrl" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" messageType="tns:getEmuCountersRequest"/>
        <variable name="urlFromScheduler" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl/pullTmbCountersScheduler" messageType="tns:TriggerEventMessage"/>
    </variables>
    <sequence>
        <receive name="ReceiveSchedulerTrigger" createInstance="yes" partnerLink="SchedulerPartner" operation="FireTriggerOperation" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl/pullTmbCountersScheduler" portType="tns:TriggerPortType" variable="urlFromScheduler"/>
        <assign name="AssignUrl">
            <sxt:trace>
                <sxt:log level="info" location="onComplete">
                    <ns0:from>concat('Got TMB counters pull scheduler trigger for URL: ', $urlFromScheduler.schedPart)</ns0:from>
                </sxt:log>
            </sxt:trace>
            <copy>
                <from variable="urlFromScheduler" part="schedPart"/>
                <to variable="emuCountersUrl" part="url"/>
            </copy>
        </assign>
        <invoke name="PullCounters" partnerLink="EmuCountersProxyPartner" operation="getEmuCounters" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" portType="tns:getEmuCountersPortType" inputVariable="emuCountersUrl" outputVariable="emuCounters"/>
        <assign name="TransformToParameterCollection">
            <copy>
                <from>ns0:doXslTransform('urn:stylesheets:emuCountersToParameterCollection.xsl', $emuCounters.counters)</from>
                <to variable="parameterCollection" part="collection"/>
            </copy>
        </assign>
        <!--
        <invoke name="SendToExSys" partnerLink="ExSysPartner" operation="getParameterCollectionOperation" xmlns:tns="http://www.cern.ch/cms/csc/exsys/wsdl" portType="tns:getParameterCollectionPortType" inputVariable="parameterCollection" outputVariable="numberOfParametersSaved"/>
        <assign name="LogExSysReply">
            <sxt:trace>
                <sxt:log level="info" location="onComplete">
                    <ns0:from>concat('Number of parameters saved:', $numberOfParametersSaved.saved)</ns0:from>
                </sxt:log>
            </sxt:trace>
            <copy>
                <from variable="urlFromScheduler" part="schedPart"/>
                <to variable="urlFromScheduler" part="schedPart"/>
            </copy>
        </assign>
        -->
    </sequence>
</process>
